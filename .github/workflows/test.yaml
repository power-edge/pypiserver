name: Test Charts

on:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'test/**'
      - '.github/workflows/test.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'test/**'
      - '.github/workflows/test.yaml'

jobs:
  lint:
    name: Lint Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint Helm chart
        run: make lint

      - name: Lint with chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Run chart-testing (lint)
        run: ct lint --config test/ct-config.yaml --charts helm/

  test-minimal:
    name: Test Minimal Config
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create pypi-test \
            --port "8080:80@loadbalancer" \
            --port "8443:443@loadbalancer" \
            --wait

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install chart
        run: |
          helm install pypi helm/ \
            -f test/values/test-minimal.yaml \
            --namespace pypi-test \
            --create-namespace \
            --wait --timeout 5m

      - name: Run Helm tests
        run: |
          helm test pypi -n pypi-test --logs

      - name: Debug on failure
        if: failure()
        run: |
          kubectl get all -n pypi-test
          kubectl describe pods -n pypi-test
          kubectl logs -n pypi-test -l app.kubernetes.io/name=pypiserver --tail=100

  test-auth:
    name: Test with Authentication
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create pypi-test \
            --port "8080:80@loadbalancer" \
            --wait

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install chart
        run: |
          helm install pypi helm/ \
            -f test/values/test-local-pv-auth.yaml \
            --namespace pypi-test \
            --create-namespace \
            --wait --timeout 5m

      - name: Run Helm tests
        run: helm test pypi -n pypi-test --logs

      - name: Debug on failure
        if: failure()
        run: |
          kubectl get all -n pypi-test
          kubectl logs -n pypi-test -l app.kubernetes.io/name=pypiserver --tail=100

  test-ha:
    name: Test HA Config
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create pypi-test \
            --port "8080:80@loadbalancer" \
            --wait

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install chart
        run: |
          helm install pypi helm/ \
            -f test/values/test-ha-config.yaml \
            --namespace pypi-test \
            --create-namespace \
            --wait --timeout 5m

      - name: Verify multiple replicas
        run: |
          REPLICAS=$(kubectl get pods -n pypi-test -l app.kubernetes.io/name=pypiserver -o name | wc -l)
          if [ "$REPLICAS" -lt 2 ]; then
            echo "ERROR: Expected 2+ replicas, got $REPLICAS"
            exit 1
          fi
          echo "✓ Found $REPLICAS replicas"

      - name: Run Helm tests
        run: helm test pypi -n pypi-test --logs

      - name: Test pod failure resilience
        run: |
          # Delete one pod and verify service continues
          kubectl delete pod -n pypi-test \
            -l app.kubernetes.io/name=pypiserver \
            --field-selector status.phase=Running \
            --wait=false | head -1

          # Wait a moment for pod to be deleted
          sleep 5

          # Verify service is still accessible
          kubectl run -n pypi-test test-curl --rm -i --restart=Never \
            --image=curlimages/curl:latest -- \
            curl -f http://pypi-pypiserver:8080/

      - name: Debug on failure
        if: failure()
        run: |
          kubectl get all -n pypi-test
          kubectl logs -n pypi-test -l app.kubernetes.io/name=pypiserver --tail=100

  test-minio-s3:
    name: Test MinIO S3 Backend
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create pypi-test \
            --port "8080:80@loadbalancer" \
            --wait

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install MinIO
        run: |
          kubectl apply -f test/fixtures/minio-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=minio -n pypi-test --timeout=120s

      - name: Install chart with S3 backend
        run: |
          helm install pypi helm/ \
            -f test/values/test-minio-s3.yaml \
            --namespace pypi-test \
            --wait --timeout 5m

      - name: Run Helm tests
        run: helm test pypi -n pypi-test --logs

      - name: Debug on failure
        if: failure()
        run: |
          kubectl get all -n pypi-test
          kubectl logs -n pypi-test -l app=minio --tail=100
          kubectl logs -n pypi-test -l app.kubernetes.io/name=pypiserver --tail=100

  test-s3-auth:
    name: Test S3 with Authentication
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create pypi-test \
            --port "8080:80@loadbalancer" \
            --wait

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install MinIO
        run: |
          kubectl apply -f test/fixtures/minio-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=minio -n pypi-test --timeout=120s

      - name: Install chart with S3 + Auth
        run: |
          helm install pypi helm/ \
            -f test/values/test-s3-auth.yaml \
            --namespace pypi-test \
            --wait --timeout 5m

      - name: Run Helm tests
        run: helm test pypi -n pypi-test --logs

      - name: Debug on failure
        if: failure()
        run: |
          kubectl get all -n pypi-test
          kubectl logs -n pypi-test -l app=minio --tail=100
          kubectl logs -n pypi-test -l app.kubernetes.io/name=pypiserver --tail=100

  test-s3-ha:
    name: Test S3 with HA
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create pypi-test \
            --port "8080:80@loadbalancer" \
            --wait

      - name: Install ingress-nginx
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s

      - name: Install MinIO
        run: |
          kubectl apply -f test/fixtures/minio-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=minio -n pypi-test --timeout=120s

      - name: Install chart with S3 + HA
        run: |
          helm install pypi helm/ \
            -f test/values/test-s3-ha.yaml \
            --namespace pypi-test \
            --wait --timeout 5m

      - name: Verify multiple replicas
        run: |
          REPLICAS=$(kubectl get pods -n pypi-test -l app.kubernetes.io/name=pypiserver -o name | wc -l)
          if [ "$REPLICAS" -lt 2 ]; then
            echo "ERROR: Expected 2+ replicas, got $REPLICAS"
            exit 1
          fi
          echo "✓ Found $REPLICAS replicas"

      - name: Run Helm tests
        run: helm test pypi -n pypi-test --logs

      - name: Test pod failure resilience
        run: |
          # Delete one pod and verify service continues
          kubectl delete pod -n pypi-test \
            -l app.kubernetes.io/name=pypiserver \
            --field-selector status.phase=Running \
            --wait=false | head -1

          # Wait a moment for pod to be deleted
          sleep 5

          # Verify service is still accessible
          kubectl run -n pypi-test test-curl --rm -i --restart=Never \
            --image=curlimages/curl:latest -- \
            curl -f http://pypi-pypiserver:8080/

      - name: Debug on failure
        if: failure()
        run: |
          kubectl get all -n pypi-test
          kubectl logs -n pypi-test -l app=minio --tail=100
          kubectl logs -n pypi-test -l app.kubernetes.io/name=pypiserver --tail=100

  test-docker-compose:
    name: Test with Docker Compose
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Docker Compose tests
        run: |
          docker compose -f docker-compose.test.yaml up \
            --abort-on-container-exit \
            --exit-code-from test-summary

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.test.yaml logs

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yaml down -v
