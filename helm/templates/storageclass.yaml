{{- if and .Values.storage.s3.enabled .Values.storage.s3.csi.enabled }}
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {{ include "pypiserver.fullname" . }}-s3
  labels:
    {{- include "pypiserver.labels" . | nindent 4 }}
provisioner: ru.yandex.s3.csi
parameters:
  mounter: geesefs
  # S3 endpoint (AWS or compatible like Hetzner)
  endpoint: {{ .Values.storage.s3.csi.endpoint | quote }}
  # Bucket name
  bucket: {{ .Values.storage.s3.bucket | quote }}
  {{- if .Values.storage.s3.csi.prefix }}
  # Optional prefix within bucket (e.g., "pypi/")
  prefix: {{ .Values.storage.s3.csi.prefix | quote }}
  {{- end }}
  # Reference to secret with credentials
  csi.storage.k8s.io/provisioner-secret-name: {{ include "pypiserver.fullname" . }}-s3-secret
  csi.storage.k8s.io/provisioner-secret-namespace: {{ .Release.Namespace }}
  csi.storage.k8s.io/controller-publish-secret-name: {{ include "pypiserver.fullname" . }}-s3-secret
  csi.storage.k8s.io/controller-publish-secret-namespace: {{ .Release.Namespace }}
  csi.storage.k8s.io/node-stage-secret-name: {{ include "pypiserver.fullname" . }}-s3-secret
  csi.storage.k8s.io/node-stage-secret-namespace: {{ .Release.Namespace }}
  csi.storage.k8s.io/node-publish-secret-name: {{ include "pypiserver.fullname" . }}-s3-secret
  csi.storage.k8s.io/node-publish-secret-namespace: {{ .Release.Namespace }}
reclaimPolicy: Retain
volumeBindingMode: Immediate
{{- end }}
